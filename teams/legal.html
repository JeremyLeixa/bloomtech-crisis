<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Team - BloomTech Crisis Response</title>
    <style>
        :root {
            --legal-primary: #dc2626;
            --legal-secondary: #991b1b;
            --legal-accent: #fef2f2;
            --dark-bg: #1f2937;
            --text-white: #f9fafb;
            --text-gray: #d1d5db;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --border-gray: #374151;
            --card-bg: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #0f172a 100%);
            color: var(--text-white);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: linear-gradient(135deg, var(--legal-primary) 0%, var(--legal-secondary) 100%);
            border-radius: 1rem;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .team-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.125rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .crisis-timer {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .timer-item {
            text-align: center;
        }

        .timer-value {
            font-size: 2rem;
            font-weight: 700;
            display: block;
        }

        .timer-label {
            font-size: 0.75rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Status Bar */
        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .status-item {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid var(--legal-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .status-icon {
            font-size: 1.5rem;
        }

        .status-text {
            flex: 1;
        }

        .status-label {
            font-size: 0.875rem;
            color: var(--text-gray);
            margin-bottom: 0.25rem;
        }

        .status-value {
            font-weight: 600;
            color: var(--text-white);
        }

        /* Work Cards */
        .work-section {
            display: grid;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .work-card {
            background: var(--card-bg);
            border-radius: 1rem;
            border: 1px solid var(--border-gray);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .work-card:hover {
            border-color: var(--legal-primary);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.15);
        }

        .card-header {
            background: linear-gradient(135deg, var(--legal-primary) 0%, var(--legal-secondary) 100%);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-status {
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-waiting {
            background: var(--warning-orange);
            color: white;
        }

        .status-available {
            background: var(--success-green);
            color: white;
        }

        .status-completed {
            background: var(--text-gray);
            color: var(--dark-bg);
        }

        .card-content {
            padding: 2rem;
        }

        /* Tooltip System */
        .tooltip {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted var(--text-gray);
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-bg);
            color: var(--text-white);
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 200px;
            white-space: normal;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Technical Analysis Display */
        .analysis-content {
            display: grid;
            gap: 1.5rem;
        }

        .analysis-item {
            background: var(--dark-bg);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-gray);
        }

        .analysis-item h4 {
            color: var(--legal-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .analysis-text {
            color: var(--text-gray);
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 3px solid var(--legal-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }

        /* Risk Assessment */
        .risk-assessment {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .risk-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--dark-bg);
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .risk-level {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .risk-level.high {
            background: #dc2626;
            color: white;
        }

        .risk-level.medium {
            background: #f59e0b;
            color: white;
        }

        .risk-level.low {
            background: #10b981;
            color: white;
        }

        .risk-label {
            flex: 1;
            font-weight: 600;
        }

        /* Form Elements */
        .legal-form {
            display: grid;
            gap: 1.5rem;
        }

        .form-group {
            display: grid;
            gap: 0.75rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--text-gray);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-input,
        .form-textarea,
        .form-select {
            background: var(--dark-bg);
            border: 1px solid var(--border-gray);
            border-radius: 0.5rem;
            padding: 0.875rem;
            color: var(--text-white);
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--legal-primary);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }

        .form-textarea.large {
            min-height: 180px;
        }

        /* FTC Response Editor */
        .ftc-editor {
            background: white;
            color: #1f2937;
            border-radius: 0.5rem;
            padding: 1.5rem;
            border: 1px solid var(--border-gray);
            margin: 1rem 0;
        }

        .ftc-header {
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .ftc-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .ftc-ref {
            font-size: 0.875rem;
            color: #6b7280;
            font-family: 'JetBrains Mono', monospace;
        }

        .ftc-content {
            line-height: 1.7;
            color: #374151;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.875rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--legal-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--legal-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .btn-secondary {
            background: var(--dark-bg);
            color: var(--text-white);
            border: 1px solid var(--border-gray);
        }

        .btn-secondary:hover {
            background: var(--border-gray);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .crisis-timer {
                gap: 1rem;
            }

            .timer-value {
                font-size: 1.5rem;
            }

            .status-bar {
                grid-template-columns: 1fr;
            }

            .chat-container {
                position: relative;
                bottom: auto;
                right: auto;
                width: 100%;
                margin-top: 2rem;
            }

            .action-buttons {
                justify-content: center;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--legal-primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Waiting Overlay */
        .waiting-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(31, 41, 55, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            transition: opacity 0.3s ease;
        }

        .waiting-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .waiting-message {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 400px;
            border: 1px solid var(--border-gray);
        }

        .waiting-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .waiting-description {
            color: var(--text-gray);
            font-size: 0.875rem;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="team-badge">
                    <span>⚖️</span>
                    <span>Legal Response Team</span>
                </div>
                <h1>Crisis Legal Management</h1>
                <p>Navigate regulatory compliance and minimize legal exposure during the BloomTech crisis.</p>
                
                <div class="crisis-timer">
                    <div class="timer-item">
                        <span class="timer-value" id="globalTimer">90:00</span>
                        <span class="timer-label">Global Timer</span>
                    </div>
                    <div class="timer-item">
                        <span class="timer-value" id="legalTimer">30:00</span>
                        <span class="timer-label">Legal Deadline</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <span class="status-icon">🔍</span>
                <div class="status-text">
                    <div class="status-label">Crisis Analysis</div>
                    <div class="status-value" id="crisisStatus">Pending</div>
                </div>
            </div>
            <div class="status-item">
                <span class="status-icon">⚖️</span>
                <div class="status-text">
                    <div class="status-label">Legal Position</div>
                    <div class="status-value" id="legalStatus">In Progress</div>
                </div>
            </div>
            <div class="status-item">
                <span class="status-icon">📰</span>
                <div class="status-text">
                    <div class="status-label">Media Approval</div>
                    <div class="status-value" id="mediaStatus">Waiting</div>
                </div>
            </div>
        </div>

        <!-- Work Section -->
        <div class="work-section">
            <!-- Technical Analysis Card -->
            <div class="work-card" id="technicalAnalysisCard">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>📊</span>
                        Technical Analysis Received
                    </h2>
                    <div class="card-status status-waiting" id="technicalStatus">WAITING</div>
                </div>
                <div class="card-content" style="position: relative;">
                    <div class="waiting-overlay" id="technicalWaitingOverlay">
                        <div class="waiting-message">
                            <div class="waiting-title">
                                <span class="loading"></span>
                                <span>Waiting for Crisis Analysis</span>
                            </div>
                            <div class="waiting-description">
                                The Crisis Analysis team is still working on their technical assessment. Legal analysis requires their findings to provide accurate regulatory guidance.
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-content" id="technicalAnalysisContent">
                        <div class="analysis-item">
                            <h4>🔍 Crisis Analysis Summary</h4>
                            <div class="analysis-text" id="crisisSummary">Waiting for Crisis Analysis team to complete their assessment...</div>
                        </div>
                        <div class="analysis-item">
                            <h4>⏱️ Technical Timeline</h4>
                            <div class="analysis-text" id="technicalTimeline">Timeline will be available once Crisis Analysis is complete...</div>
                        </div>
                        <div class="analysis-item">
                            <h4>🛡️ Prevention Plan</h4>
                            <div class="analysis-text" id="preventionPlan">Prevention measures pending Crisis Analysis findings...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legal Risk Assessment Card -->
            <div class="work-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>📊</span>
                        <span class="tooltip" data-tooltip="Évaluer les risques juridiques pour l'entreprise - quels sont les dangers légaux de cette crise ?">Legal Risk Assessment</span>
                    </h2>
                    <div class="card-status status-available">AVAILABLE</div>
                </div>
                <div class="card-content">
                    <div class="ftc-editor">
                        <div class="ftc-header">
                            <div class="ftc-title">Federal Trade Commission Response</div>
                            <div class="ftc-ref">Reference: BloomTech-FTC-2025-001</div>
                        </div>
                        <div class="ftc-content" id="ftcPreview">
                            <p><strong>Official response will appear here as you draft it below...</strong></p>
                        </div>
                    </div>

                    <form class="legal-form" id="ftcResponseForm">
                        <div class="form-group">
                            <label class="form-label">
                                <span>📝</span>
                                <span class="tooltip" data-tooltip="Reconnaissance des faits - qu'est-ce qui s'est réellement passé sans esquiver la responsabilité">Acknowledgment of Issues</span>
                            </label>
                            <textarea class="form-textarea" placeholder="Acknowledge the technical issues and their impact on consumers..." id="acknowledgment"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <span>🔧</span>
                                <span class="tooltip" data-tooltip="Actions correctives = ce que l'entreprise fait concrètement pour réparer les dégâts">Corrective Actions Taken</span>
                            </label>
                            <textarea class="form-textarea" placeholder="Detail immediate steps taken to address the technical problems..." id="correctiveActions"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <span>🛡️</span>
                                <span class="tooltip" data-tooltip="Mesures préventives = ce que l'entreprise met en place pour que ça ne se reproduise jamais">Prevention Measures</span>
                            </label>
                            <textarea class="form-textarea" placeholder="Explain systems and processes implemented to prevent recurrence..." id="preventionMeasures"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <span>👥</span>
                                <span class="tooltip" data-tooltip="Compensation des consommateurs - comment l'entreprise dédommage les clients lésés">Consumer Remediation</span>
                            </label>
                            <textarea class="form-textarea" placeholder="Outline compensation or remediation offered to affected consumers..." id="consumerRemediation"></textarea>
                        </div>

                        <div class="action-buttons">
                            <button type="button" class="btn btn-secondary" onclick="saveDraft('ftc')">
                                <span>💾</span>
                                Save Draft
                            </button>
                            <button type="button" class="btn btn-primary" onclick="completeFTCResponse()">
                                <span>📤</span>
                                Submit FTC Response
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Media Approval Card -->
            <div class="work-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>📢</span>
                        <span class="tooltip" data-tooltip="Autoriser l'équipe Media à communiquer publiquement - décision critique qui engage la responsabilité légale">Media Communication Approval</span>
                    </h2>
                    <div class="card-status status-available">AVAILABLE</div>
                </div>
                <div class="card-content">
                    <div class="analysis-item" style="margin-bottom: 1.5rem;">
                        <h4>📋 Communication Guidelines</h4>
                        <div class="analysis-text">
                            <strong>APPROVED messaging must:</strong><br>
                            • Acknowledge issues without admitting legal liability<br>
                            • Focus on corrective actions, not blame or excuses<br>
                            • Avoid technical details that could worsen FTC position<br>
                            • Include consumer remediation commitment<br>
                            • Maintain professional, apologetic tone
                        </div>
                    </div>

                    <form class="legal-form" id="mediaApprovalForm">
                        <div class="form-group">
                            <label class="form-label">
                                <span>📝</span>
                                Approved Key Messages
                            </label>
                            <textarea class="form-textarea large" placeholder="Provide specific talking points and approved language for Media Team to use..." id="approvedMessages"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <span>🚫</span>
                                Restricted Topics
                            </label>
                            <textarea class="form-textarea" placeholder="List topics and phrases that Media Team must avoid to prevent legal complications..." id="restrictedTopics"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <span>⚖️</span>
                                Legal Approval Status
                            </label>
                            <select class="form-select" id="approvalStatus" onchange="updateApprovalStatus()">
                                <option value="pending">Review in Progress</option>
                                <option value="approved">✅ APPROVED - Media can communicate</option>
                                <option value="conditional">⚠️ CONDITIONAL - Restrictions apply</option>
                                <option value="denied">❌ DENIED - No public communication</option>
                            </select>
                        </div>

                        <div class="action-buttons">
                            <button type="button" class="btn btn-secondary" onclick="saveDraft('media')">
                                <span>💾</span>
                                Save Guidelines
                            </button>
                            <button type="button" class="btn btn-primary" onclick="approveMediaCommunication()">
                                <span>✅</span>
                                Send Approval to Media Team
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    

    <script>
        // Global state management
        const legalState = {
            riskAssessmentComplete: false,
            ftcResponseComplete: false,
            mediaApprovalComplete: false,
            crisisAnalysisReceived: false,
            startTime: Date.now(),
            legalDeadline: 30 * 60 * 1000, // 30 minutes
            globalDeadline: 90 * 60 * 1000 // 90 minutes
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeLegalInterface();
            checkCrisisAnalysisStatus();
            startTimers();
            loadSavedData();
            scheduleEvents();
        });

        function initializeLegalInterface() {
            console.log('[Legal] Interface initialized');
            
            // Add auto-save to all textareas
            document.querySelectorAll('textarea').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    saveDraft(this.id);
                });
            });

            // Update FTC preview in real-time
            const ftcFields = ['acknowledgment', 'correctiveActions', 'preventionMeasures', 'consumerRemediation'];
            ftcFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateFTCPreview);
                }
            });
        }

        function checkCrisisAnalysisStatus() {
            const crisisComplete = localStorage.getItem('crisis_analysis_complete');
            
            if (crisisComplete === 'true') {
                receiveCrisisAnalysis();
            } else {
                // Check periodically for crisis analysis completion
                setInterval(checkCrisisAnalysisStatus, 5000);
            }
        }

        function receiveCrisisAnalysis() {
            if (legalState.crisisAnalysisReceived) return;
            
            legalState.crisisAnalysisReceived = true;
            
            // Update status
            document.getElementById('crisisStatus').textContent = 'Complete';
            document.getElementById('technicalStatus').textContent = 'RECEIVED';
            document.getElementById('technicalStatus').className = 'card-status status-available';
            
            // Hide waiting overlay
            document.getElementById('technicalWaitingOverlay').classList.add('hidden');
            
            // Load crisis analysis data from JSON storage
            let crisisData = {
                summary: 'Technical analysis not yet available...',
                timeline: 'Timeline not yet available...',
                prevention: 'Prevention plan not yet available...'
            };
            
            // Try to get data from crisis_analysis_draft (JSON format)
            const crisisDraft = localStorage.getItem('crisis_analysis_draft');
            if (crisisDraft) {
                try {
                    const parsedData = JSON.parse(crisisDraft);
                    crisisData = {
                        summary: parsedData.summary || crisisData.summary,
                        timeline: parsedData.timeline || crisisData.timeline,
                        prevention: parsedData.prevention || crisisData.prevention
                    };
                } catch (e) {
                    console.warn('[Legal] Could not parse crisis_analysis_draft JSON:', e);
                }
            }
            
            // Try alternative keys if JSON parsing failed
            if (!crisisDraft) {
                crisisData = {
                    summary: localStorage.getItem('crisis_analysis_summary') || crisisData.summary,
                    timeline: localStorage.getItem('crisis_analysis_timeline') || crisisData.timeline,
                    prevention: localStorage.getItem('crisis_analysis_prevention') || crisisData.prevention
                };
            }
            
            // Populate analysis sections with real data
            document.getElementById('crisisSummary').textContent = crisisData.summary;
            document.getElementById('technicalTimeline').textContent = crisisData.timeline;
            document.getElementById('preventionPlan').textContent = crisisData.prevention;
            
           
            
            console.log('[Legal] Crisis analysis received and processed:', crisisData);
        }

        function startTimers() {
            setInterval(function() {
                const elapsed = Date.now() - legalState.startTime;
                
                // Global timer (90 minutes)
                const globalRemaining = Math.max(0, legalState.globalDeadline - elapsed);
                const globalMinutes = Math.floor(globalRemaining / 60000);
                const globalSeconds = Math.floor((globalRemaining % 60000) / 1000);
                document.getElementById('globalTimer').textContent = 
                    `${globalMinutes}:${globalSeconds.toString().padStart(2, '0')}`;
                
                // Legal timer (30 minutes)
                const legalRemaining = Math.max(0, legalState.legalDeadline - elapsed);
                const legalMinutes = Math.floor(legalRemaining / 60000);
                const legalSecondsVal = Math.floor((legalRemaining % 60000) / 1000);
                document.getElementById('legalTimer').textContent = 
                    `${legalMinutes}:${legalSecondsVal.toString().padStart(2, '0')}`;
                
                // Add urgency styling when time is running out
                if (legalRemaining < 300000) { // Less than 5 minutes
                    document.getElementById('legalTimer').style.color = '#dc2626';
                }
            }, 1000);
        }

        function saveDraft(type) {
            const data = {};
            
            if (type === 'risk' || type.includes('ftc') || type.includes('Concerns')) {
                data.ftcConcerns = document.getElementById('ftcConcerns')?.value || '';
                data.riskMitigation = document.getElementById('riskMitigation')?.value || '';
                data.compliancePlan = document.getElementById('compliancePlan')?.value || '';
            }
            
            if (type === 'ftc' || type.includes('acknowledgment')) {
                data.acknowledgment = document.getElementById('acknowledgment')?.value || '';
                data.correctiveActions = document.getElementById('correctiveActions')?.value || '';
                data.preventionMeasures = document.getElementById('preventionMeasures')?.value || '';
                data.consumerRemediation = document.getElementById('consumerRemediation')?.value || '';
            }
            
            if (type === 'media' || type.includes('approved')) {
                data.approvedMessages = document.getElementById('approvedMessages')?.value || '';
                data.restrictedTopics = document.getElementById('restrictedTopics')?.value || '';
                data.approvalStatus = document.getElementById('approvalStatus')?.value || '';
            }
            
            localStorage.setItem('legal_draft', JSON.stringify(data));
            console.log('[Legal] Draft saved:', type);
        }

        function loadSavedData() {
            const saved = localStorage.getItem('legal_draft');
            if (saved) {
                const data = JSON.parse(saved);
                Object.keys(data).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = data[key];
                    }
                });
                updateFTCPreview();
            }
        }

        function updateFTCPreview() {
            const acknowledgment = document.getElementById('acknowledgment')?.value || '';
            const correctiveActions = document.getElementById('correctiveActions')?.value || '';
            const preventionMeasures = document.getElementById('preventionMeasures')?.value || '';
            const consumerRemediation = document.getElementById('consumerRemediation')?.value || '';
            
            let preview = '<p><strong>Federal Trade Commission</strong><br>Consumer Protection Bureau</p>';
            
            if (acknowledgment) {
                preview += `<p><strong>Issue Acknowledgment:</strong><br>${acknowledgment}</p>`;
            }
            if (correctiveActions) {
                preview += `<p><strong>Immediate Actions:</strong><br>${correctiveActions}</p>`;
            }
            if (preventionMeasures) {
                preview += `<p><strong>Prevention Measures:</strong><br>${preventionMeasures}</p>`;
            }
            if (consumerRemediation) {
                preview += `<p><strong>Consumer Remediation:</strong><br>${consumerRemediation}</p>`;
            }
            
            if (acknowledgment || correctiveActions || preventionMeasures || consumerRemediation) {
                preview += '<p><em>Respectfully submitted,<br>BloomTech Legal Department</em></p>';
            } else {
                preview = '<p><strong>Official response will appear here as you draft it below...</strong></p>';
            }
            
            document.getElementById('ftcPreview').innerHTML = preview;
        }

        function completeRiskAssessment() {
            const ftcConcerns = document.getElementById('ftcConcerns').value.trim();
            const riskMitigation = document.getElementById('riskMitigation').value.trim();
            const compliancePlan = document.getElementById('compliancePlan').value.trim();
            
            if (!ftcConcerns || !riskMitigation || !compliancePlan) {
                alert('Please complete all risk assessment fields before submitting.');
                return;
            }
            
            legalState.riskAssessmentComplete = true;
            localStorage.setItem('legal_risk_assessment_complete', 'true');
            
            // Update UI
            const riskCard = document.getElementById('riskAssessmentForm').closest('.work-card');
            const statusBadge = riskCard.querySelector('.card-status');
            statusBadge.textContent = 'COMPLETED';
            statusBadge.className = 'card-status status-completed';
            
            //addChatMessage('System', '✅ Risk Assessment complete. Analysis available to other teams.', 'system');
            updateOverallStatus();
            
            console.log('[Legal] Risk assessment completed');
        }

        function completeFTCResponse() {
            const acknowledgment = document.getElementById('acknowledgment').value.trim();
            const correctiveActions = document.getElementById('correctiveActions').value.trim();
            const preventionMeasures = document.getElementById('preventionMeasures').value.trim();
            const consumerRemediation = document.getElementById('consumerRemediation').value.trim();
            
            if (!acknowledgment || !correctiveActions || !preventionMeasures || !consumerRemediation) {
                alert('Please complete all sections of the FTC response before submitting.');
                return;
            }
            
            legalState.ftcResponseComplete = true;
            localStorage.setItem('legal_ftc_response_complete', 'true');
            
            // Store FTC response content for other teams
            const ftcData = {
                acknowledgment, correctiveActions, preventionMeasures, consumerRemediation,
                submittedAt: new Date().toISOString()
            };
            localStorage.setItem('legal_ftc_response_data', JSON.stringify(ftcData));
            
            // Update UI
            const ftcCard = document.getElementById('ftcResponseForm').closest('.work-card');
            const statusBadge = ftcCard.querySelector('.card-status');
            statusBadge.textContent = 'SUBMITTED';
            statusBadge.className = 'card-status status-completed';
            
            //addChatMessage('System', '📤 FTC Response submitted. Legal position established.', 'system');
            updateOverallStatus();
            
            console.log('[Legal] FTC response completed and submitted');
        }

        function updateApprovalStatus() {
            const status = document.getElementById('approvalStatus').value;
            const mediaStatus = document.getElementById('mediaStatus');
            
            switch(status) {
                case 'approved':
                    mediaStatus.textContent = 'Approved';
                    mediaStatus.style.color = '#10b981';
                    break;
                case 'conditional':
                    mediaStatus.textContent = 'Conditional';
                    mediaStatus.style.color = '#f59e0b';
                    break;
                case 'denied':
                    mediaStatus.textContent = 'Denied';
                    mediaStatus.style.color = '#dc2626';
                    break;
                default:
                    mediaStatus.textContent = 'Waiting';
                    mediaStatus.style.color = '#6b7280';
            }
        }

      function approveMediaCommunication() {
    console.log('=== DEBUG START ===');
    
    const approvedMessagesElement = document.getElementById('approvedMessages');
    const restrictedTopicsElement = document.getElementById('restrictedTopics');
    const approvalStatusElement = document.getElementById('approvalStatus');
    
    console.log('Elements found:', {
        approvedMessages: approvedMessagesElement,
        restrictedTopics: restrictedTopicsElement,
        approvalStatus: approvalStatusElement
    });
    
    const approvedMessages = approvedMessagesElement.value;
    const restrictedTopics = restrictedTopicsElement.value;
    const approvalStatus = approvalStatusElement.value;
    
    console.log('Values extracted:', {
        approvedMessages: approvedMessages,
        restrictedTopics: restrictedTopics,
        approvalStatus: approvalStatus
    });
    
    const approvalData = {
        approvedMessages, 
        restrictedTopics, 
        approvalStatus,
        approvedAt: new Date().toISOString()
    };
    
    console.log('Data object created:', approvalData);
    
    const jsonString = JSON.stringify(approvalData);
    console.log('JSON string:', jsonString);
    
    localStorage.setItem('legal_media_approval_data', jsonString);
    console.log('Saved to localStorage');
    
    // Vérification immédiate
    const savedData = localStorage.getItem('legal_media_approval_data');
    console.log('Retrieved from localStorage:', savedData);
    
    console.log('=== DEBUG END ===');
}

        function updateOverallStatus() {
            const legalStatus = document.getElementById('legalStatus');
            
            if (legalState.riskAssessmentComplete && legalState.ftcResponseComplete && legalState.mediaApprovalComplete) {
                legalStatus.textContent = 'Complete';
                legalStatus.style.color = '#10b981';
                localStorage.setItem('legal_team_complete', 'true');
                
               
                
                // Celebrate completion
                setTimeout(() => {
                    alert('🎉 Congratulations! Legal Team has successfully completed all crisis response objectives.');
                }, 1000);
            } else {
                const completed = [legalState.riskAssessmentComplete, legalState.ftcResponseComplete, legalState.mediaApprovalComplete].filter(Boolean).length;
                legalStatus.textContent = `${completed}/3 Complete`;
            }
        }

        function scheduleEvents() {
            // Media pressure at 1 minute
            setTimeout(() => {
                //addChatMessage('Media Team', 'Legal, we need approval guidance ASAP. Journalists are asking questions!', 'received');
            }, 60000);
            
            // Strategy pressure at 5 minutes
            setTimeout(() => {
                //addChatMessage('Strategy Team', 'Legal team, board wants risk assessment for emergency meeting. How exposed are we?', 'received');
            }, 300000);
            
            // Urgent approval request at 10 minutes
            setTimeout(() => {
                //addChatMessage('Media Team', 'URGENT: Major news outlet wants statement in 20 minutes. Can we get approval status?', 'received');
            }, 600000);
            
            // Crisis Analysis delivers at 20 minutes
            setTimeout(() => {
                if (!legalState.crisisAnalysisReceived) {
                    localStorage.setItem('crisis_analysis_complete', 'true');
                    receiveCrisisAnalysis();
                   // addChatMessage('Crisis Analysis', 'Technical analysis complete! Root cause identified - you can now finalize FTC response.', 'received');
                }
            }, 1200000);
        }

      

        

        // CEO Dashboard Integration (receives broadcasts)
        window.addEventListener('storage', function(e) {
            if (e.key === 'ceo_broadcast') {
                const broadcast = JSON.parse(e.newValue);
               // addChatMessage('CEO', broadcast.message, 'system');
            }
        });

        // Emergency reset (hidden feature for instructor)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                if (confirm('Reset Legal Team interface? This will clear all data.')) {
                    localStorage.removeItem('legal_draft');
                    localStorage.removeItem('legal_risk_assessment_complete');
                    localStorage.removeItem('legal_ftc_response_complete');
                    localStorage.removeItem('legal_media_approval_complete');
                    localStorage.removeItem('legal_team_complete');
                    location.reload();
                }
            }
        });
    </script>
</body>
</html>
                    <div class="risk-assessment">
                        <div class="risk-item">
                            <div class="risk-level high">HIGH</div>
                            <div class="risk-label">FTC Violation Risk</div>
                        </div>
                        <div class="risk-item">
                            <div class="risk-level medium">MEDIUM</div>
                            <div class="risk-label">Customer Lawsuit Risk</div>
                        </div>
                        <div class="risk-item">
                            <div class="risk-level high">HIGH</div>
                            <div class="risk-label">Regulatory Investigation</div>
                        </div>
                        <div class="risk-item">
                            <div class="risk-level medium">MEDIUM</div>
                            <div class="risk-label">Brand Damage Claims</div>
                        </div>
                    </div>

                    <form class="legal-form" id="riskAssessmentForm">
                        <div class="form-group">
                            <label class="form-label">
                                <span>⚠️</span>
                                <span class="tooltip" data-tooltip="FTC = Federal Trade Commission, l'agence américaine qui protège les consommateurs contre les publicités trompeuses">Primary FTC Concerns</span>
                            </label>
                            <textarea class="form-textarea" placeholder="Identify the main legal issues the FTC will focus on (false advertising, misleading claims, etc.)" id="ftcConcerns"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <span>🛡️</span>
                                <span class="tooltip" data-tooltip="Quelles actions immédiates pour réduire les risques juridiques ?">Immediate Risk Mitigation</span>
                            </label>
                            <textarea class="form-textarea" placeholder="List urgent actions to minimize legal exposure (cease communications, preserve documents, etc.)" id="riskMitigation"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <span>📋</span>
                                <span class="tooltip" data-tooltip="Plan de conformité = actions pour respecter les règles légales et éviter d'autres problèmes">Compliance Action Plan</span>
                            </label>
                            <textarea class="form-textarea large" placeholder="Outline steps to ensure regulatory compliance and prevent future violations..." id="compliancePlan"></textarea>
                        </div>

                        <div class="action-buttons">
                            <button type="button" class="btn btn-secondary" onclick="saveDraft('risk')">
                                <span>💾</span>
                                Save Draft
                            </button>
                            <button type="button" class="btn btn-primary" onclick="completeRiskAssessment()">
                                <span>✅</span>
                                Complete Risk Assessment
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- FTC Response Card -->
            <div class="work-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>📄</span>
                        <span class="tooltip" data-tooltip="Rédiger la réponse officielle à l'agence fédérale américaine - document très important qui peut sauver ou couler l'entreprise">Official FTC Response</span>
                    </h2>
                    <div class="card-status status-available">AVAILABLE</div>
                </div>
                <div class="card-content">
